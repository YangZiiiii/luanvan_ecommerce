<!DOCTYPE html>
<html lang="en">

<head>
   <title>Shoping Cart</title>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />
   <!--===============================================================================================-->
   <link rel="icon" type="image/png" href="./assets/images/icons/favicon.png" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/bootstrap/css/bootstrap.min.css" />
   <!--===============================================================================================-->
   <!-- <link rel="stylesheet" type="text/css" href="./assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" /> -->
   <link rel="stylesheet" href="./assets/fonts/fontawesome-free-6.1.1-web/css/all.min.css">

   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/fonts/iconic/css/material-design-iconic-font.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/fonts/linearicons-v1.0.0/icon-font.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/animate/animate.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/css-hamburgers/hamburgers.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/animsition/css/animsition.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/select2/select2.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/perfect-scrollbar/perfect-scrollbar.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/css/util.css" />
   <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />
   <link rel="stylesheet" type="text/css" href="./assets/css/header.css" />

   <!--===============================================================================================-->

   <!--Header-Template  -->
   <script src="./assets/js/template/header.js"></script>

   <!--Cart-Template  -->
   <script src="./assets/js/template/cart.js"></script>

   <!--Cart-Bread-Template  -->
   <script src="./assets/js/template/cart/bread-crumb.js"></script>

   <!--Cart-Item-Template  -->
   <script src="./assets/js/template/cart/item-cart.js"></script>

   <!--Footer-Template  -->
   <script src="./assets/js/template/footer.js"></script>
</head>

<body class="animsition">
   <!-- Header -->
   <!-- <header-main-v4></header-main-v4> -->
   <header-main></header-main>

   <!-- Cart -->
   <!-- <cart-main></cart-main> -->

   <!-- breadcrumb -->
   <cart-bread></cart-bread>

   <!-- Shoping Cart -->
   <!-- <cart-item></cart-item> -->
   <div class="container">
      <div class="row"></div>
      <div class="row">
         <div class="col-lg-12  m-b-50 p-0">
            <div class="m-lr-0-xl">
               <div class="wrap-table-shopping-cart">
                  <table class="table-shopping-cart" id="cart-table">
                     <tr class="table_head">
                        <th class="column-1">Product</th>
                        <th class="column-2">Name</th>
                        <th class="column-3">Price</th>
                        <th class="column-4">Quantity</th>
                        <th class="column-5">Total</th>
                        <th class="column-3" style="text-align: center;">Tool</th>
                     </tr>
                     <!-- Cart items will be rendered here -->
                  </table>
               </div>

               <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                  <!-- <div class="flex-w flex-m m-r-20 m-tb-5">
                     <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text" name="coupon"
                        placeholder="Coupon Code" />

                     <div class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
                        Apply coupon
                     </div>
                  </div> -->

                  <div class="total__price" style="flex: 1; justify-content: flex-end;">
                     <div class="flex-c-m stext-101 cl2 size-119   p-lr-15 trans-04 m-tb-10">
                        Total: <span id="cart-total-price">0đ</span>
                     </div>


                     <a href="checkout.html">
                        <div
                           class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10">
                           Pay Order
                        </div>
                     </a>
                  </div>
                  <style>
                     .total__price {
                        display: flex;
                        gap: 10px;
                     }

                     .total__price span {
                        margin-left: 4px;
                     }

                     .btn-delete-item {
                        text-align: center;
                     }

                     .btn-delete-item:hover {
                        color: #ed340f;
                        cursor: pointer;
                     }
                  </style>
               </div>
            </div>
         </div>
      </div>
   </div>
   <script>
      var changeServer = '160.30.192.116';
      function updateFavouriteCount() {
         const favourites = localStorage.getItem('favouriteProductIds');
         const numberOfFavourites = document.querySelector('.icon-heart-number[data-notify]');
         if (numberOfFavourites) {
            let count = 0;
            if (favourites) {
               try {
                  const favouriteIds = JSON.parse(favourites);
                  count = Array.isArray(favouriteIds) ? favouriteIds.length : 0;
               } catch {
                  count = 0;
               }
            }
            numberOfFavourites.setAttribute('data-notify', count);
         }
      }
      updateFavouriteCount();


      function formatPrice(price) {
         if (!price) return '0₫';
         return price.toLocaleString('vi-VN') + '₫';
      }

      // Helper for local cart quantities
      function getCartQuantities() {
         let cartQty = {};
         try {
            cartQty = JSON.parse(localStorage.getItem('cartQuantities')) || {};
         } catch (e) {
            cartQty = {};
         }
         return cartQty;
      }

      function setCartQuantities(cartQty) {
         localStorage.setItem('cartQuantities', JSON.stringify(cartQty));
      }

      async function fetchAndRenderCartTable() {
         const userId = localStorage.getItem('userId');
         if (!userId) {
            // Local cart
            let items = [];
            try {
               items = JSON.parse(localStorage.getItem('cartLocal')) || [];
            } catch (e) {
               items = [];
            }
            const cartQty = getCartQuantities();
            renderCartTable(items, cartQty, false);
            return;
         }

         try {
            const res = await fetch(`http://${changeServer}:8080/api/v1/cart?userId=${userId}`);
            const data = await res.json();
            if (data.statusCode === 200 && data.data && Array.isArray(data.data.items)) {
               const items = data.data.items.map(item => ({
                  id: item.productId,
                  name: item.productName,
                  primaryImageURL: item.imageUrl,
                  unitPrice: item.unitPrice
               }));
               const cartQty = {};
               data.data.items.forEach(item => {
                  cartQty[item.productId] = item.quantity;
               });
               renderCartTable(items, cartQty, true);
            } else {
               renderCartTable([], {}, true);
            }
         } catch (e) {
            console.error('Error fetching cart:', e);
            renderCartTable([], {}, true);
         }
      }

      function renderCartTable(items = [], cartQty = {}, isUser = true) {
         const table = document.getElementById('cart-table');
         while (table.rows.length > 1) table.deleteRow(1);
         let total = 0;

         if (items.length === 0) {
            const row = table.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 6;
            cell.innerHTML = `<div class="header__cart-msg" style="text-align:center;padding:20px 0;">No products yet</div>`;
         } else {
            items.forEach((item, idx) => {
               const quantity = cartQty[item.id] ?? 0;
               const price = item.unitPrice || 0;
               const totalPrice = price * quantity;
               total += totalPrice;

               const row = table.insertRow();
               row.className = 'table_row';

               let cell = row.insertCell(0);
               cell.className = 'column-1';
               cell.innerHTML = `
                  <a href="productDetail.html?productId=${item.id}" data-product-index="${idx}" style="display:inline-block;">
                     <div class="how-itemcart1" style="cursor:pointer;">
                        <img src="${item.primaryImageURL || './assets/images/emptycart.png'}" alt="IMG" data-product-id="${item.id}" />
                     </div>
                  </a>`;

               cell = row.insertCell(1);
               cell.className = 'column-2';
               cell.textContent = item.name || '';

               cell = row.insertCell(2);
               cell.className = 'column-3';
               cell.textContent = formatPrice(price);

               cell = row.insertCell(3);
               cell.className = 'column-4';
               cell.innerHTML = `
                  <div class="wrap-num-product flex-w m-l-auto m-r-0">
                     <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m" data-idx="${idx}">
                        <i class="fs-16 zmdi zmdi-minus"></i>
                     </div>
                     <input class="mtext-104 cl3 txt-center num-product" type="number" min="1" value="${quantity}" />
                     <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m" data-idx="${idx}">
                        <i class="fs-16 zmdi zmdi-plus"></i>
                     </div>
                  </div>`;

               cell = row.insertCell(4);
               cell.className = 'column-5';
               cell.textContent = formatPrice(totalPrice);

               cell = row.insertCell(5);
               cell.className = 'column-3 btn-delete-item';
               cell.style.textAlign = 'center';
               cell.style.cursor = 'pointer';
               cell.textContent = 'Delete';
               cell.setAttribute('data-idx', idx);
            });
         }

         document.getElementById('cart-total-price').textContent = formatPrice(total);

         // Delete logic
         document.querySelectorAll('.btn-delete-item').forEach(btn => {
            btn.addEventListener('click', async function () {
               let idx = parseInt(this.getAttribute('data-idx'));
               const productId = items[idx]?.id;
               if (!productId) return;

               if (isUser) {
                  try {
                     await fetch(
                        `http://${changeServer}:8080/api/v1/cart/remove?userId=${encodeURIComponent(localStorage.getItem('userId'))}&productId=${encodeURIComponent(productId)}`,
                        {
                           method: 'DELETE',
                           headers: { 'Content-Type': 'application/json' }
                        }
                     );
                     items.splice(idx, 1);
                     delete cartQty[productId];

                     renderCartTable(items, cartQty, true);
                     if (typeof updateCartNotify === 'function') updateCartNotify();
                  } catch (e) {
                     console.error('Error deleting item:', e);
                  }
               } else {
                  let itemsLocal = [];
                  try {
                     itemsLocal = JSON.parse(localStorage.getItem('cartLocal')) || [];
                  } catch (e) {
                     itemsLocal = [];
                  }
                  let cartQtyLocal = getCartQuantities();
                  const id = itemsLocal[idx]?.id;
                  if (id !== undefined) {
                     itemsLocal.splice(idx, 1);
                     delete cartQtyLocal[id];
                     localStorage.setItem('cartLocal', JSON.stringify(itemsLocal));
                     setCartQuantities(cartQtyLocal);
                  }
                  renderCartTable(itemsLocal, cartQtyLocal, false);
                  if (typeof updateCartNotify === 'function') updateCartNotify();
               }
            });
         });

         // Update quantity logic
         document.querySelectorAll('.wrap-num-product').forEach((wrap, idx) => {
            const qtyInput = wrap.querySelector('.num-product');
            const minusBtn = wrap.querySelector('.btn-num-product-down');
            const plusBtn = wrap.querySelector('.btn-num-product-up');
            const priceDiv = table.rows[idx + 1]?.cells[4]; // total price cell
            let cartLocal = [];
            try {
               cartLocal = JSON.parse(localStorage.getItem('cartLocal')) || [];
            } catch (e) {
               cartLocal = [];
            }
            let cartQty = getCartQuantities();
            const item = items[idx];
            const id = item?.id;
            const userId = localStorage.getItem('userId');
            const unitPrice = (typeof item.unitPrice !== 'undefined') ? item.unitPrice : (item.sellingPrice ?? 0);

            function updatePriceDisplay(val) {
               const price = unitPrice * val;
               if (priceDiv) priceDiv.textContent = formatPrice(price);
            }

            function updateQuantity(val) {
               if (isNaN(val) || val < 1) val = 1;
               if (val === (cartQty[id] ?? 0)) return;
               if (!isUser) {
                  cartQty[id] = val;
                  setCartQuantities(cartQty);
                  renderCartTable(items, cartQty, false);
                  if (typeof updateCartNotify === 'function') updateCartNotify();
               } else {
                  fetch(`http://${changeServer}:8080/api/v1/cart/update?userId=${userId}&productId=${id}&newQuantity=${val}`, {
                     method: 'PUT'
                  })
                     .then(res => res.json())
                     .then(data => {
                        if (data && data.statusCode === 400 && data.message) {
                           swal("Cảnh báo", "Không đủ số lượng sản phẩm", "warning");
                        } else {
                           cartQty[id] = val;
                           setCartQuantities(cartQty);
                           renderCartTable(items, cartQty, true);
                           if (typeof updateCartNotify === 'function') updateCartNotify();
                        }
                     })
                     .catch(() => {
                        cartQty[id] = val;
                        setCartQuantities(cartQty);
                        renderCartTable(items, cartQty, true);
                        if (typeof updateCartNotify === 'function') updateCartNotify();
                     });
               }
            }

            qtyInput && qtyInput.addEventListener('input', function () {
               this.value = this.value.replace(/[^0-9]/g, '');
               let val = parseInt(this.value);
               if (isNaN(val) || val < 1) val = 1;
               updatePriceDisplay(val);
               updateQuantity(val);
            });

            minusBtn && minusBtn.addEventListener('click', function () {
               let val = parseInt(qtyInput.value) || 1;
               if (val > 1) {
                  val--;
                  qtyInput.value = val;
                  updatePriceDisplay(val);
                  updateQuantity(val);
               }
            });

            plusBtn && plusBtn.addEventListener('click', function () {
               let val = parseInt(qtyInput.value) || 1;
               val++;
               qtyInput.value = val;
               updatePriceDisplay(val);
               updateQuantity(val);
            });
         });

         // No need for image click event, since image is wrapped in <a>
      }

      // Gọi khi DOM đã load
      document.addEventListener('DOMContentLoaded', function () {
         fetchAndRenderCartTable();
         var cartIcon = document.getElementById('cart-icon-header');
         console.log(cartIcon);
         if (cartIcon) cartIcon.classList.add('cart-none');
      });

      document.addEventListener('DOMContentLoaded', function () {

         let searchIcon = document.getElementById('icon-search_items');
         console.log(searchIcon);
         if (searchIcon) searchIcon.classList.add('search-none');
      });

     
       
   </script>

   <!-- Footer -->
   <footer-main></footer-main>

   <!-- Back to top -->
   <div class="btn-back-to-top" id="myBtn">
      <span class="symbol-btn-back-to-top">
         <i class="zmdi zmdi-chevron-up"></i>
      </span>
   </div>

   <!--===============================================================================================-->
   <script src="./assets/vendor/jquery/jquery-3.2.1.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/animsition/js/animsition.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/bootstrap/js/popper.js"></script>
   <script src="./assets/vendor/bootstrap/js/bootstrap.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/select2/select2.min.js"></script>
   <script>
      $(".js-select2").each(function () {
         $(this).select2({
            minimumResultsForSearch: 20,
            dropdownParent: $(this).next(".dropDownSelect2"),
         });
      });
   </script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
   <script>
      $(".js-pscroll").each(function () {
         $(this).css("position", "relative");
         $(this).css("overflow", "hidden");
         var ps = new PerfectScrollbar(this, {
            wheelSpeed: 1,
            scrollingThreshold: 1000,
            wheelPropagation: false,
         });

         $(window).on("resize", function () {
            ps.update();
         });
      });
   </script>
   <!--===============================================================================================-->
   <script src="./assets/js/main.js"></script>
</body>

</html>