<!DOCTYPE html>
<html lang="en">

<head>
   <title>Shoping Cart</title>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />
   <!--===============================================================================================-->
   <link rel="icon" type="image/png" href="./assets/images/icons/favicon.png" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/bootstrap/css/bootstrap.min.css" />
   <!--===============================================================================================-->
   <!-- <link rel="stylesheet" type="text/css" href="./assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" /> -->
   <link rel="stylesheet" href="./assets/fonts/fontawesome-free-6.1.1-web/css/all.min.css">

   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/fonts/iconic/css/material-design-iconic-font.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/fonts/linearicons-v1.0.0/icon-font.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/animate/animate.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/css-hamburgers/hamburgers.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/animsition/css/animsition.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/select2/select2.min.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/vendor/perfect-scrollbar/perfect-scrollbar.css" />
   <!--===============================================================================================-->
   <link rel="stylesheet" type="text/css" href="./assets/css/util.css" />
   <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />
   <link rel="stylesheet" type="text/css" href="./assets/css/header.css" />

   <!--===============================================================================================-->

   <!--Header-Template  -->
   <script src="./assets/js/template/header.js"></script>

   <!--Cart-Template  -->
   <script src="./assets/js/template/cart.js"></script>

   <!--Cart-Bread-Template  -->
   <script src="./assets/js/template/cart/bread-crumb.js"></script>

   <!--Cart-Item-Template  -->
   <script src="./assets/js/template/cart/item-cart.js"></script>

   <!--Footer-Template  -->
   <script src="./assets/js/template/footer.js"></script>
</head>

<body class="animsition">
   <!-- Header -->
   <!-- <header-main-v4></header-main-v4> -->
   <header-main></header-main>

   <!-- Cart -->
   <!-- <cart-main></cart-main> -->

   <!-- breadcrumb -->
   <cart-bread></cart-bread>

   <!-- Shoping Cart -->
   <!-- <cart-item></cart-item> -->
   <div class="container">
      <div class="row"></div>
      <div class="row">
         <div class="col-lg-12  m-b-50 p-0">
            <div class="m-lr-0-xl">
               <div class="wrap-table-shopping-cart">
                  <table class="table-shopping-cart" id="cart-table">
                     <tr class="table_head">
                        <th class="column-1">Product</th>
                        <th class="column-2"></th>
                        <th class="column-3">Price</th>
                        <th class="column-4">Quantity</th>
                        <th class="column-5">Total</th>
                        <th class="column-3" style="text-align: center;">Tool</th>
                     </tr>
                     <!-- Cart items will be rendered here -->
                  </table>
               </div>

               <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                  <div class="flex-w flex-m m-r-20 m-tb-5">
                     <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text" name="coupon"
                        placeholder="Coupon Code" />

                     <div class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">
                        Apply coupon
                     </div>
                  </div>

                  <div class="total__price">
                     <div class="flex-c-m stext-101 cl2 size-119   p-lr-15 trans-04 m-tb-10">
                        Total: <span id="cart-total-price">0đ</span>
                     </div>

                     <div class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10">
                        Update Cart
                     </div>
                     <div class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10">
                        Pay Order
                     </div>
                  </div>
                  <style>
                     .total__price {
                        display: flex;
                        gap: 10px;
                     }

                     .total__price span {
                        margin-left: 4px;
                     }

                     .btn-delete-item {
                        text-align: center;
                     }

                     .btn-delete-item:hover {
                        color: #ed340f;
                        cursor: pointer;
                     }
                  </style>
               </div>
            </div>
         </div>
      </div>
   </div>
   <script>
      // // Helper to format price as "1.000.000đ"
      // function formatPrice(price) {
      //    return price.toLocaleString('vi-VN') + 'đ';
      // }

      // // Get cart quantities from localStorage
      // function getCartQuantities() {
      //    let cartQty = {};
      //    try {
      //    cartQty = JSON.parse(localStorage.getItem('cartQuantities')) || {};
      //    } catch (e) {
      //    cartQty = {};
      //    }
      //    return cartQty;
      // }

      // // Set cart quantities to localStorage
      // function setCartQuantities(cartQty) {
      //    localStorage.setItem('cartQuantities', JSON.stringify(cartQty));
      // }

      // // Render cart table rows
      // async function renderCartTable() {
      //    const table = document.getElementById('cart-table');
      //    // Remove all rows except the header
      //    while (table.rows.length > 1) table.deleteRow(1);

      //    let items = [];
      //    let cartQty = {};
      //    let total = 0;

      //    // Check for userId in localStorage
      //    const userId = localStorage.getItem('userId');
      //    if (userId) {
      //    // Fetch cart from API
      //    try {
      //       const res = await fetch(`http://localhost:8080/api/v1/cart?userId=${userId}`);
      //       const data = await res.json();
      //       if (data.statusCode === 200 && data.data && Array.isArray(data.data.items)) {
      //       items = data.data.items.map(item => ({
      //          id: item.productId,
      //          name: item.productName,
      //          primaryImageURL: item.imageUrl,
      //          sellingPrice: item.sellingPrice
      //       }));
      //       cartQty = {};
      //       data.data.items.forEach(item => {
      //          cartQty[item.productId] = item.quantity;
      //       });
      //       }
      //    } catch (e) {
      //       items = [];
      //       cartQty = {};
      //    }
      //    } else {
      //    // Local cart logic
      //    try {
      //       items = JSON.parse(localStorage.getItem('cartLocal')) || [];
      //    } catch (e) {
      //       items = [];
      //    }
      //    cartQty = getCartQuantities();
      //    }

      //    if (items.length === 0) {
      //    const row = table.insertRow();
      //    const cell = row.insertCell(0);
      //    cell.colSpan = 6;
      //    cell.innerHTML = `<div class="header__cart-msg" style="text-align:center;padding:20px 0;">No products yet</div>`;
      //    } else {
      //    items.forEach((item, idx) => {
      //       const quantity = cartQty[item.id] ?? 0;
      //       const price = item.sellingPrice || 0;
      //       const totalPrice = price * quantity;
      //       total += totalPrice;

      //       const row = table.insertRow();
      //       row.className = 'table_row';
      //       // Product image
      //       let cell = row.insertCell(0);
      //       cell.className = 'column-1';
      //       cell.innerHTML = `<div class="how-itemcart1"><img src="${item.primaryImageURL || './assets/images/emptycart.png'}" alt="IMG" /></div>`;
      //       // Product name
      //       cell = row.insertCell(1);
      //       cell.className = 'column-2';
      //       cell.textContent = item.name || '';
      //       // Price
      //       cell = row.insertCell(2);
      //       cell.className = 'column-3';
      //       cell.textContent = formatPrice(price);
      //       // Quantity
      //       cell = row.insertCell(3);
      //       cell.className = 'column-4';
      //       cell.innerHTML = `
      //    <div class="wrap-num-product flex-w m-l-auto m-r-0">
      //       <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m" data-idx="${idx}">
      //       <i class="fs-16 zmdi zmdi-minus"></i>
      //       </div>
      //       <input class="mtext-104 cl3 txt-center num-product" type="number" min="1" value="${quantity}" readonly />
      //       <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m" data-idx="${idx}">
      //       <i class="fs-16 zmdi zmdi-plus"></i>
      //       </div>
      //    </div>
      //    `;
      //       // Total
      //       cell = row.insertCell(4);
      //       cell.className = 'column-5';
      //       cell.textContent = formatPrice(totalPrice);
      //       // Delete
      //       cell = row.insertCell(5);
      //       cell.className = 'column-3 btn-delete-item';
      //       cell.style.textAlign = 'center';
      //       cell.style.cursor = 'pointer';
      //       cell.textContent = 'Delete';
      //       cell.setAttribute('data-idx', idx);
      //    });
      //    }
      //    document.getElementById('cart-total-price').textContent = formatPrice(total);

      //    // Add event listeners for delete
      //    if (userId) {
      //    document.querySelectorAll('.btn-delete-item').forEach(btn => {
      //       btn.addEventListener('click', async function () {
      //       let idx = parseInt(this.getAttribute('data-idx'));
      //       const productId = items[idx]?.id;
      //       if (!productId) return;

      //       // Build items array for body (remaining items except the one to delete)
      //       const newItems = [];
      //       for (let i = 0; i < items.length; i++) {
      //          if (i !== idx) {
      //          newItems.push({
      //             productId: items[i].id,
      //             quantity: cartQty[items[i].id]
      //          });
      //          }
      //       }

      //       try {
      //          await fetch(
      //          `http://localhost:8080/api/v1/cart/remove?userId=${encodeURIComponent(userId)}&productId=${encodeURIComponent(productId)}`,
      //          {
      //             method: 'DELETE',
      //             headers: {
      //             'Content-Type': 'application/json'
      //             },
      //             body: JSON.stringify({
      //             userId: userId,
      //             items: newItems
      //             })
      //          }
      //          );
      //       } catch (e) {
      //          // handle error if needed
      //       }
      //       renderCartTable();
      //       if (typeof updateCartNotify === 'function') updateCartNotify();
      //       });
      //    });
      //    } else {
      //    // Add event listeners for delete (local cart)
      //    document.querySelectorAll('.btn-delete-item').forEach(btn => {
      //       btn.addEventListener('click', function () {
      //       let idx = parseInt(this.getAttribute('data-idx'));
      //       let items = [];
      //       try {
      //          items = JSON.parse(localStorage.getItem('cartLocal')) || [];
      //       } catch (e) {
      //          items = [];
      //       }
      //       let cartQty = getCartQuantities();
      //       const id = items[idx]?.id;
      //       if (id !== undefined) {
      //          items.splice(idx, 1);
      //          delete cartQty[id];
      //          localStorage.setItem('cartLocal', JSON.stringify(items));
      //          setCartQuantities(cartQty);
      //       }
      //       renderCartTable();
      //       if (typeof updateCartNotify === 'function') updateCartNotify();
      //       });
      //    });

      //    // Add event listeners for quantity plus/minus (only for local cart)
      //    document.querySelectorAll('.btn-num-product-down').forEach(btn => {
      //       btn.addEventListener('click', function () {
      //       let idx = parseInt(this.getAttribute('data-idx'));
      //       let items = [];
      //       try {
      //          items = JSON.parse(localStorage.getItem('cartLocal')) || [];
      //       } catch (e) {
      //          items = [];
      //       }
      //       let cartQty = getCartQuantities();
      //       const id = items[idx]?.id;
      //       if (id !== undefined && (cartQty[id] ?? 0) > 1) {
      //          cartQty[id] = (cartQty[id] ?? 1) - 1;
      //          setCartQuantities(cartQty);
      //          renderCartTable();
      //          if (typeof updateCartNotify === 'function') updateCartNotify();
      //       }
      //       });
      //    });
      //    document.querySelectorAll('.btn-num-product-up').forEach(btn => {
      //       btn.addEventListener('click', function () {
      //       let idx = parseInt(this.getAttribute('data-idx'));
      //       let items = [];
      //       try {
      //          items = JSON.parse(localStorage.getItem('cartLocal')) || [];
      //       } catch (e) {
      //          items = [];
      //       }
      //       let cartQty = getCartQuantities();
      //       const id = items[idx]?.id;
      //       if (id !== undefined) {
      //          cartQty[id] = (cartQty[id] ?? 1) + 1;
      //          setCartQuantities(cartQty);
      //          renderCartTable();
      //          if (typeof updateCartNotify === 'function') updateCartNotify();
      //       }
      //       });
      //    });
      //    }
      // }

      // // Hide cart icon on this page
      // document.addEventListener('DOMContentLoaded', function () {
      //    renderCartTable();
      //    var cartIcon = document.getElementById('cart-icon-header');
      //    if (cartIcon) {
      //    cartIcon.classList.add('cart-none');
      //    }
      // });
      function formatPrice(price) {
         if (!price) return '0₫';
         return price.toLocaleString('vi-VN') + '₫';
      }

      async function fetchAndRenderCartTable() {
         const userId = localStorage.getItem('userId');
         if (!userId) {
            renderCartTable([], {});
            return;
         }

         try {
            const res = await fetch(`http://localhost:8080/api/v1/cart?userId=${userId}`);
            const data = await res.json();
            if (data.statusCode === 200 && data.data && Array.isArray(data.data.items)) {
               const items = data.data.items.map(item => ({
                  id: item.productId,
                  name: item.productName,
                  primaryImageURL: item.imageUrl,
                  sellingPrice: item.sellingPrice
               }));
               const cartQty = {};
               data.data.items.forEach(item => {
                  cartQty[item.productId] = item.quantity;
               });
               renderCartTable(items, cartQty);
            } else {
               renderCartTable([], {});
            }
         } catch (e) {
            console.error('Error fetching cart:', e);
            renderCartTable([], {});
         }
      }

      function renderCartTable(items = [], cartQty = {}) {
         const table = document.getElementById('cart-table');
         while (table.rows.length > 1) table.deleteRow(1);
         let total = 0;

         if (items.length === 0) {
            const row = table.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 6;
            cell.innerHTML = `<div class="header__cart-msg" style="text-align:center;padding:20px 0;">No products yet</div>`;
         } else {
            items.forEach((item, idx) => {
               const quantity = cartQty[item.id] ?? 0;
               const price = item.sellingPrice || 0;
               const totalPrice = price * quantity;
               total += totalPrice;

               const row = table.insertRow();
               row.className = 'table_row';

               let cell = row.insertCell(0);
               cell.className = 'column-1';
               cell.innerHTML = `<div class="how-itemcart1"><img src="${item.primaryImageURL || './assets/images/emptycart.png'}" alt="IMG" /></div>`;

               cell = row.insertCell(1);
               cell.className = 'column-2';
               cell.textContent = item.name || '';

               cell = row.insertCell(2);
               cell.className = 'column-3';
               cell.textContent = formatPrice(price);

               cell = row.insertCell(3);
               cell.className = 'column-4';
               cell.innerHTML = `
        <div class="wrap-num-product flex-w m-l-auto m-r-0">
          <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m" data-idx="${idx}">
            <i class="fs-16 zmdi zmdi-minus"></i>
          </div>
          <input class="mtext-104 cl3 txt-center num-product" type="number" min="1" value="${quantity}" readonly />
          <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m" data-idx="${idx}">
            <i class="fs-16 zmdi zmdi-plus"></i>
          </div>
        </div>`;

               cell = row.insertCell(4);
               cell.className = 'column-5';
               cell.textContent = formatPrice(totalPrice);

               cell = row.insertCell(5);
               cell.className = 'column-3 btn-delete-item';
               cell.style.textAlign = 'center';
               cell.style.cursor = 'pointer';
               cell.textContent = 'Delete';
               cell.setAttribute('data-idx', idx);
            });
         }

         document.getElementById('cart-total-price').textContent = formatPrice(total);

         // Gắn sự kiện delete
         const userId = localStorage.getItem('userId');
         if (userId) {
            document.querySelectorAll('.btn-delete-item').forEach(btn => {
               btn.addEventListener('click', async function () {
                  let idx = parseInt(this.getAttribute('data-idx'));
                  const productId = items[idx]?.id;
                  if (!productId) return;

                  try {
                     await fetch(
                        `http://localhost:8080/api/v1/cart/remove?userId=${encodeURIComponent(userId)}&productId=${encodeURIComponent(productId)}`,
                        {
                           method: 'DELETE',
                           headers: { 'Content-Type': 'application/json' }
                        }
                     );
                     // Xóa tại chỗ
                     items.splice(idx, 1);
                     delete cartQty[productId];

                     renderCartTable(items, cartQty);
                     if (typeof updateCartNotify === 'function') updateCartNotify();
                  } catch (e) {
                     console.error('Error deleting item:', e);
                  }
               });
            });
         }
      }

      // Gọi khi DOM đã load
      document.addEventListener('DOMContentLoaded', function () {
         fetchAndRenderCartTable();
         var cartIcon = document.getElementById('cart-icon-header');
         if (cartIcon) cartIcon.classList.add('cart-none');
      });

   </script>

   <!-- Footer -->
   <footer-main></footer-main>

   <!-- Back to top -->
   <div class="btn-back-to-top" id="myBtn">
      <span class="symbol-btn-back-to-top">
         <i class="zmdi zmdi-chevron-up"></i>
      </span>
   </div>

   <!--===============================================================================================-->
   <script src="./assets/vendor/jquery/jquery-3.2.1.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/animsition/js/animsition.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/bootstrap/js/popper.js"></script>
   <script src="./assets/vendor/bootstrap/js/bootstrap.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/select2/select2.min.js"></script>
   <script>
      $(".js-select2").each(function () {
         $(this).select2({
            minimumResultsForSearch: 20,
            dropdownParent: $(this).next(".dropDownSelect2"),
         });
      });
   </script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
   <!--===============================================================================================-->
   <script src="./assets/vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
   <script>
      $(".js-pscroll").each(function () {
         $(this).css("position", "relative");
         $(this).css("overflow", "hidden");
         var ps = new PerfectScrollbar(this, {
            wheelSpeed: 1,
            scrollingThreshold: 1000,
            wheelPropagation: false,
         });

         $(window).on("resize", function () {
            ps.update();
         });
      });
   </script>
   <!--===============================================================================================-->
   <script src="./assets/js/main.js"></script>
</body>

</html>