<!DOCTYPE html>
<html lang="en">

<head>
    <title>Shoping Cart</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="./assets/images/icons/favicon.png" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/bootstrap/css/bootstrap.min.css" />
    <!--===============================================================================================-->
    <!-- <link rel="stylesheet" type="text/css" href="./assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" /> -->
    <link rel="stylesheet" href="./assets/fonts/fontawesome-free-6.1.1-web/css/all.min.css">

    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/iconic/css/material-design-iconic-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/linearicons-v1.0.0/icon-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animate/animate.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/css-hamburgers/hamburgers.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animsition/css/animsition.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/select2/select2.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/perfect-scrollbar/perfect-scrollbar.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/css/util.css" />
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />


    <link rel="stylesheet" href="./assets/css/gridInfo.css">
    <link rel="stylesheet" href="./assets/css/seeOrder.css">
    <link rel="stylesheet" href="./assets/css/header.css">


    <!--===============================================================================================-->

    <!--Header-Template  -->
    <script src="./assets/js/template/header.js"></script>

    <!--Cart-Template  -->
    <script src="./assets/js/template/cart.js"></script>

    <!--Cart-Bread-Template  -->
    <script src="./assets/js/template/cart/bread-crumb.js"></script>

    <!--Cart-Item-Template  -->
    <script src="./assets/js/template/cart/item-cart.js"></script>

    <!--Footer-Template  -->
    <script src="./assets/js/template/footer.js"></script>
</head>

<body class="animsition">
    <!-- Header -->
    <header-main></header-main>


    <div class="container-info">
        <div class="grid wide">
            <div class="row">
                <div class="col l-2 ">
                    <div class="category">
                        <div class="category__user">
                            <img src="./assets/images/default-avatar.jpg" alt="" class="category__img"
                                id="sidebarAvatar">
                            <div class="category__information">
                                <span class="category__name" id="sidebarUserName">User name</span>
                            </div>
                        </div>


                        <div class="myAccount">
                            <div>
                                <a href="loginInfo.html" class="myAccount__link-list">
                                    <i class="myAccount__icon fa-solid fa-user"></i><span>Tài khoản của tôi</span>
                                </a>
                            </div>

                            <div>
                                <a href="passwordInfo.html" class="myAccount__link-list">
                                    <i class="myAccount__icon-ticket fa-solid fa-lock"></i>
                                    <span">Mật khẩu</span>
                                </a>
                            </div>

                            <div>
                                <a href="orderInfo.html" class="myAccount__link-list active">
                                    <i class="myAccount__icon-list fa-solid fa-clipboard-list"></i>Đơn mua</span>
                                </a>
                            </div>

                            <!-- <div>
                                <a href="#" class="myAccount__link-list">
                                    <i class="myAccount__icon-ticket fa-solid fa-ticket"></i>
                                    <span">Kho Voucher</span>
                                </a>
                            </div> -->
                                           
                        </div>
                    </div>
                </div>
                <div class="col l-10 ">
                    <div class="follow">
                        <div class="follow__menu">
                            <ul class="follow__list" id="order-filter-list">
                                <li class="follow__item">
                                    <a href="#" class="follow__link follow__link-active" data-status="">
                                        Tất cả
                                    </a>
                                </li>
                                <li class="follow__item">
                                    <a href="#" class="follow__link" data-status="PENDING">
                                        Chờ xác nhận
                                    </a>
                                </li>
                                <li class="follow__item">
                                    <a href="#" class="follow__link" data-status="PROCESSING">
                                        Đang xử lý
                                    </a>
                                </li>
                                <li class="follow__item">
                                    <a href="#" class="follow__link" data-status="SHIPPED">
                                        Đang giao đi
                                    </a>
                                </li>
                                <li class="follow__item">
                                    <a href="#" class="follow__link" data-status="DELIVERED">
                                        Đã giao
                                    </a>
                                </li>
                             
                            </ul>
                        </div>

                        <div id="orders-container"></div>

                        <script>
                            var changeServer = "160.30.192.116";
                            // Load user information into sidebar
                            document.addEventListener("DOMContentLoaded", function () {
                                const userId = localStorage.getItem('userId');
                                if (userId) {
                                    fetch(`http://${changeServer}:8080/api/v1/user/uid/${userId}`)
                                        .then(res => res.json())
                                        .then(json => {
                                            if (json.statusCode === 200 && json.data) {
                                                const user = json.data;
                                                document.getElementById("sidebarUserName").textContent = user.firstName + " " + user.lastName;
                                                if (user.avatarUrl) {
                                                    document.getElementById("sidebarAvatar").src = user.avatarUrl;
                                                }
                                            }
                                        });
                                }
                            });


                            function formatCurrency(amount) {
                                if (!amount) return "₫0";
                                return "₫" + amount.toLocaleString("vi-VN");
                            }
                            function formatDate(timestamp) {
                                if (!timestamp) return "";
                                const date = new Date(timestamp);
                                return date.toLocaleString("vi-VN");
                            }
                            function renderOrder(order) {
                                console.log("Rendering order:", order);
                                
                                const productTotal = order.totalPrice && order.shippingFee ? (order.totalPrice - order.shippingFee) : order.totalPrice;
                                return `
                                <div class="price">
                                    <div class="product">
                                        <div class="manipulation">
                                            <div class="manipulation__menu">
                                                <p class="manipulation__content"><span class="order-date__title">Mã đơn hàng:</span> ${order.id}</p>
                                                <p class="manipulation__content"><span class="order-date__title">Ngày đặt:</span> ${formatDate(order.orderDate)}</p>
                                                <p class="manipulation__content"><span class="order-date__title">Trạng thái:</span> ${order.orderStatus}</p>

                                            </div>
                                            <div class="assess">
                                                <p class="assess__evaluated">${order.orderStatus === "PENDING" ? "CHỜ XÁC NHẬN" : "ĐÃ ĐÁNH GIÁ"}</p>
                                            </div>
                                        </div>
                                        <div class="product__list-item">
                                            ${order.items.map(item => `
                                            <div class="product__item">
                                                <div class="product__introduce">
                                                    <img src="${item.imageUrl ? item.imageUrl : './assets/images/gai.jpg'}" alt="" class="product__img">
                                                    <div class="product__content">
                                                        <p class="product__name">${item.productName}</p>
                                                        <p class="product__quantity">x${item.quantity}</p>
                                                    </div>
                                                </div>
                                                <div class="product__price">
                                                    <span class="product__price-new">${formatCurrency(item.unitPrice)}</span>
                                                </div>
                                            </div>
                                            `).join("")}
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="total">
                                        <div class="total__money" style="display: flex; align-items: center; justify-content: space-between;">
                                            <span style="display: flex; align-items: center; gap: 8px;">
                                                <i class="total__icon fa-solid fa-sack-dollar"></i>
                                                <span class="total__content">Tổng tiền sản phẩm:</span>
                                            </span>
                                            <span class="total__price">${formatCurrency(productTotal)}</span>
                                        </div>
                                        <div class="total__money" style="display: flex; align-items: center; justify-content: space-between;">
                                            <span style="display: flex; align-items: center; gap: 8px;">
                                                <i class="total__icon fa-solid fa-truck"></i>
                                                <span class="total__content">Phí vận chuyển:</span>
                                            </span>
                                            <span class="total__price">${formatCurrency(order.shippingFee)}</span>
                                        </div>
                                        <div class="total__money" style="display: flex; align-items: center; justify-content: space-between;">
                                            <span style="display: flex; align-items: center; gap: 8px;">
                                                <i class="total__icon fa-solid fa-money-bill-wave"></i>
                                                <span class="total__content">Tổng số tiền:</span>
                                            </span>
                                            <span class="total__price">${formatCurrency(order.totalPrice)}</span>
                                        </div>
                                        <div class="total__btn">
                                             <!-- <div class="total__btn-all">
                                                <button class="total__btn-buy">Mua lại</button>
                                                <button class="total__btn-contact">Liên hệ người bán</button>
                                                <button class="total__btn-see">Xem đánh giá shop</button>
                                            </div> -->
                                            
                                        </div>
                                    </div>
                                </div>
                                `;
                            }

                            let allOrders = [];

                            function renderOrdersByStatus(status) {
                                const container = document.getElementById("orders-container");
                                let filtered = [];
                                // Nếu status là "" (Tất cả), lấy hết
                                if (!status) {
                                    filtered = allOrders;
                                } else {
                                    filtered = allOrders.filter(o => o.orderStatus === status);
                                }
                                if (filtered.length > 0) {
                                    container.innerHTML = filtered.map(renderOrder).join("");
                                } else {
                                    container.innerHTML = `
                                        <div class="no-order">
                                            <img src="./assets/images/image.png" alt="">
                                        </div>
                                    `;
                                }
                            }

                            // Lấy userId từ localStorage (giả sử lưu dưới key 'userId')
                            const userId = localStorage.getItem('userId');
                            if (userId) {
                                fetch(`http://${changeServer}:8080/api/v1/order/user/${userId}`)
                                    .then(res => res.json())
                                    .then(json => {
                                        if (json.statusCode === 200 && Array.isArray(json.data)) {
                                            // Sắp xếp order mới nhất lên đầu (orderDate là timestamp lớn hơn là mới hơn)
                                            allOrders = json.data.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                                            renderOrdersByStatus(""); 
                                        } else {
                                            document.getElementById("orders-container").innerHTML = `
                                                <div class="no-order">
                                                    <img src="./assets/images/image.png" alt="">
                                                </div>
                                            `;
                                        }
                                    })
                                    .catch(() => {
                                        document.getElementById("orders-container").innerHTML = "<p>Lỗi khi tải đơn hàng.</p>";
                                    });
                            } else {
                                document.getElementById("orders-container").innerHTML = "<p>Vui lòng đăng nhập để xem đơn hàng.</p>";
                            }

                            // Handle tab click
                            document.getElementById("order-filter-list").addEventListener("click", function (e) {
                                const link = e.target.closest(".follow__link");
                                if (link) {
                                    e.preventDefault();
                                    // Remove active from all
                                    document.querySelectorAll(".follow__link").forEach(el => el.classList.remove("follow__link-active"));
                                    // Add active to clicked
                                    link.classList.add("follow__link-active");
                                    // Render orders
                                    const status = link.getAttribute("data-status");
                                    renderOrdersByStatus(status);
                                }
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer-main></footer-main>

    <!-- Back to top -->
    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>

    <!--===============================================================================================-->
    <script src="./assets/vendor/jquery/jquery-3.2.1.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/animsition/js/animsition.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/bootstrap/js/popper.js"></script>
    <script src="./assets/vendor/bootstrap/js/bootstrap.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/select2/select2.min.js"></script>
    <script>
        $(".js-select2").each(function () {
            $(this).select2({
                minimumResultsForSearch: 20,
                dropdownParent: $(this).next(".dropDownSelect2"),
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script>
        $(".js-pscroll").each(function () {
            $(this).css("position", "relative");
            $(this).css("overflow", "hidden");
            var ps = new PerfectScrollbar(this, {
                wheelSpeed: 1,
                scrollingThreshold: 1000,
                wheelPropagation: false,
            });

            $(window).on("resize", function () {
                ps.update();
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/js/main.js"></script>
</body>

</html>