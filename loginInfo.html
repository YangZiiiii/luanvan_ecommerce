<!DOCTYPE html>
<html lang="en">

<head>
    <title>Shoping Cart</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="./assets/images/icons/favicon.png" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/bootstrap/css/bootstrap.min.css" />
    <!--===============================================================================================-->
    <!-- <link rel="stylesheet" type="text/css" href="./assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" /> -->
    <link rel="stylesheet" href="./assets/fonts/fontawesome-free-6.1.1-web/css/all.min.css">

    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/iconic/css/material-design-iconic-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/linearicons-v1.0.0/icon-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animate/animate.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/css-hamburgers/hamburgers.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animsition/css/animsition.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/select2/select2.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/perfect-scrollbar/perfect-scrollbar.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/css/util.css" />
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />


    <link rel="stylesheet" href="./assets/css/gridInfo.css">
    <link rel="stylesheet" href="./assets/css/loginInfo.css">
    <link rel="stylesheet" href="./assets/css/header.css">


    <!--===============================================================================================-->

    <!--Header-Template  -->
    <script src="./assets/js/template/header.js"></script>

    <!--Cart-Template  -->
    <script src="./assets/js/template/cart.js"></script>

    <!--Cart-Bread-Template  -->
    <script src="./assets/js/template/cart/bread-crumb.js"></script>

    <!--Cart-Item-Template  -->
    <script src="./assets/js/template/cart/item-cart.js"></script>

    <!--Footer-Template  -->
    <script src="./assets/js/template/footer.js"></script>
</head>

<body class="animsition">
    <!-- Header -->
    <header-main></header-main>


    <div class="container-info">
        <div class="grid wide">
            <div class="row padding-main">
                <div class="col l-2 ">
                    <div class="category">
                        <div class="category__user">
                            <img src="./assets/images/default-avatar.jpg" alt="" class="category__img" id="sidebarAvatar">
                            <div class="category__information">
                                <span class="category__name" id="sidebarUserName">User name</span>
                            </div>
                        </div>
                        <div class="myAccount">
                            <div>
                                <a href="#" class="myAccount__link-list active">
                                    <i class="myAccount__icon fa-solid fa-user"></i><span>Tài khoản của tôi</span>
                                </a>
                            </div>

                            <div>
                                <a href="passwordInfo.html" class="myAccount__link-list">
                                    <i class="myAccount__icon-ticket fa-solid fa-lock"></i>
                                    <span">Mật khẩu</span>
                                </a>
                            </div>

                            <div>
                                <a href="orderInfo.html" class="myAccount__link-list">
                                    <i class="myAccount__icon-list fa-solid fa-clipboard-list"></i>Đơn mua</span>
                                </a>
                            </div>

                            <!-- <div>
                                <a href="#" class="myAccount__link-list">
                                    <i class="myAccount__icon-ticket fa-solid fa-ticket"></i>
                                    <span">Kho Voucher</span>
                                </a>
                            </div> -->

                        </div>
                    </div>
                </div>
                <div class="col l-10 ">
                    <div class="formClient">
                        <div class="formClient__content">
                            <p class="formClient__file-content">Hồ sơ của tôi</p>
                            <p class="formClient__manager-content">Quản lí thông tin hồ sơ để bảo mật tài khoản</p>
                        </div>
                        <div class="row form__infor">
                            <div class="col l-8">
                                <form action="" class="form__user" id="userForm">
                                    <div class="login input-locked">
                                        <p class="login__text">First name</p>
                                        <input type="text" class="login__input-text" id="firstName" readonly
                                            tabindex="-1">
                                    </div>
                                    <div class="name mt-12 input-locked">
                                        <p class="name__text">Last name</p>
                                        <input type="text" class="login__input-text" id="lastName" readonly
                                            tabindex="-1">
                                    </div>
                                    <div class="phone mt-12 input-locked">
                                        <p class="phone__change">Phone</p>
                                        <input type="number" class="login__input-text" id="phone" readonly tabindex="-1">
                                    </div>
                                    <div class="form__actions">
                                        <button type="button" class="link__edit" id="editBtn">Sửa</button>
                                        <button type="button" class="link__cancel" id="cancelBtn"
                                            style="display:none;">Hủy</button>
                                    </div>
                                </form>
                                <div id="toast-container"
                                    style="position: fixed; top: 100px; right: 45%; z-index: 9999;"></div>
                                <script>
                                    var changeServer = '160.30.192.116';
                                    function showToast(message, type = 'info') {
                                        const toast = document.createElement('div');
                                        toast.className = `toast toast-${type}`;
                                        toast.textContent = message;
                                        toast.style.minWidth = '200px';
                                        toast.style.marginBottom = '12px';
                                        toast.style.padding = '12px 24px';
                                        toast.style.borderRadius = '6px';
                                        toast.style.background = type === 'success' ? '#4caf50' : (type === 'error' ? '#f44336' : '#2196f3');
                                        toast.style.color = '#fff';
                                        toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                                        toast.style.fontSize = '16px';
                                        toast.style.opacity = '0.95';
                                        document.getElementById('toast-container').appendChild(toast);
                                        setTimeout(() => {
                                            toast.style.transition = 'opacity 0.5s';
                                            toast.style.opacity = '0';
                                            setTimeout(() => toast.remove(), 500);
                                        }, 500);
                                    }

                                    document.addEventListener('DOMContentLoaded', function () {
                                        const userId = localStorage.getItem('userId');
                                        if (!userId) return;
                                        fetch(`http://${changeServer}:8080/api/v1/user/uid/${userId}`)
                                            .then(res => res.json())
                                            .then(json => {
                                                if (json.statusCode === 200 && json.data) {
                                                    document.getElementById('firstName').value = json.data.firstName || '';
                                                    document.getElementById('lastName').value = json.data.lastName || '';
                                                    document.getElementById('phone').value = json.data.phone || '';
                                                    // Update sidebar name
                                                    document.getElementById('sidebarUserName').textContent = (json.data.firstName || '') + ' ' + (json.data.lastName || '');
                                                    // Update sidebar avatar if available
                                                    if (json.data.avatarUrl) {
                                                        document.getElementById('sidebarAvatar').src = json.data.avatarUrl;
                                                        document.getElementById('avatarPreview').src = json.data.avatarUrl;
                                                    }
                                                }
                                            })
                                            .catch(() => { });
                                    });
                                </script>
                            </div>
                            <script>
                                const userForm = document.getElementById('userForm');
                                const editBtn = document.getElementById('editBtn');
                                const cancelBtn = document.getElementById('cancelBtn');
                                const inputs = userForm.querySelectorAll('.login__input-text');
                                let originalValues = [];
                                let isEditing = false;

                                function setReadonlyState(isReadonly) {
                                    inputs.forEach(input => {
                                        if (isReadonly) {
                                            input.setAttribute('readonly', true);
                                            input.setAttribute('tabindex', -1);
                                            input.style.pointerEvents = 'none';
                                            input.addEventListener('focus', preventFocus, true);
                                        } else {
                                            input.removeAttribute('readonly');
                                            input.setAttribute('tabindex', 0);
                                            input.style.pointerEvents = 'auto';
                                            input.removeEventListener('focus', preventFocus, true);
                                        }
                                    });
                                }

                                function preventFocus(e) {
                                    e.target.blur();
                                    e.preventDefault();
                                }

                                setReadonlyState(true);

                                editBtn.addEventListener('click', async function (e) {
                                    e.preventDefault();
                                    const userId = localStorage.getItem('userId');
                                    if (!isEditing) {
                                        // Start editing
                                        originalValues = Array.from(inputs).map(input => input.value);
                                        setReadonlyState(false);
                                        editBtn.textContent = 'Lưu';
                                        cancelBtn.style.display = '';
                                        isEditing = true;
                                        if (inputs[0]) {
                                            inputs[0].focus();
                                            inputs[0].setSelectionRange(inputs[0].value.length, inputs[0].value.length);
                                        }
                                    } else {
                                        // Save
                                        setReadonlyState(true);
                                        editBtn.textContent = 'Sửa';
                                        cancelBtn.style.display = 'none';
                                        isEditing = false;

                                        // Call API to update user info
                                        if (!userId) return;
                                        const body = {
                                            firstName: document.getElementById('firstName').value,
                                            lastName: document.getElementById('lastName').value,
                                            phone: document.getElementById('phone').value
                                        };
                                        try {
                                            const res = await fetch(`http://${changeServer}:8080/api/v1/user/${userId}`, {
                                                method: 'PUT',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify(body)
                                            });
                                            const json = await res.json();
                                            if (json.statusCode === 200 && json.data) {
                                                // Show success toast
                                                showToast('Cập nhật thành công!', 'success');
                                                originalValues = [
                                                    json.data.firstName || '',
                                                    json.data.lastName || '',
                                                    json.data.phone || ''
                                                ];
                                                // Update sidebar name
                                                document.getElementById('sidebarUserName').textContent = (json.data.firstName || '') + ' ' + (json.data.lastName || '');
                                            } else {
                                                showToast('Cập nhật thất bại!', 'error');
                                            }
                                        } catch (err) {
                                            showToast('Có lỗi xảy ra!', 'error');
                                        }
                                    }
                                });

                                cancelBtn.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    // Restore original values
                                    inputs.forEach((input, idx) => {
                                        input.value = originalValues[idx] || '';
                                    });
                                    setReadonlyState(true);
                                    editBtn.textContent = 'Sửa';
                                    cancelBtn.style.display = 'none';
                                    isEditing = false;
                                });

                                userForm.addEventListener('submit', function (e) {
                                    e.preventDefault();
                                });
                            </script>
                            <div class="col l-4">
                                <div class="myImg">
                                    <img src="./assets/images/default-avatar.jpg" alt="" class="myImg__show" id="avatarPreview">
                                    <input type="file" id="avatarInput" accept="image/jpeg,image/png" style="display:none" />
                                    <a href="#" class="myImg__link" id="chooseAvatarBtn">Chọn ảnh</a>
                                    <p class="myImg__contetn">Dung lượng file tối đa 5 MB</p>
                                    <p class="myImg__contetn">Định dạng: .JPEG, .PNG</p>
                                </div>
                                <style>
                                    .spinner {
                                        display: inline-block;
                                        width: 22px;
                                        height: 22px;
                                        vertical-align: middle;
                                        margin-right: 8px;
                                    }
                                    .spinner:after {
                                        content: " ";
                                        display: block;
                                        width: 22px;
                                        height: 22px;
                                        border-radius: 50%;
                                        border: 3px solid #fff;
                                        border-color: #fff #fff #bbb #fff;
                                        animation: spinner-rotate 0.8s linear infinite;
                                    }
                                    @keyframes spinner-rotate {
                                        0% { transform: rotate(0deg);}
                                        100% { transform: rotate(360deg);}
                                    }
                                </style>
                                <script>
                                    const chooseAvatarBtn = document.getElementById('chooseAvatarBtn');
                                    const avatarInput = document.getElementById('avatarInput');
                                    const avatarPreview = document.getElementById('avatarPreview');
                                    const sidebarAvatar = document.getElementById('sidebarAvatar');

                                    // Hàm toast loading với spinner
                                    function showLoadingToast(message = 'Đang xử lý...') {
                                        const toast = document.createElement('div');
                                        toast.className = 'toast toast-loading';
                                        toast.style.minWidth = '200px';
                                        toast.style.marginBottom = '12px';
                                        toast.style.padding = '12px 24px';
                                        toast.style.borderRadius = '6px';
                                        toast.style.background = '#888';
                                        toast.style.color = '#fff';
                                        toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                                        toast.style.fontSize = '16px';
                                        toast.style.opacity = '0.95';
                                        toast.id = 'loading-toast';

                                        // Spinner
                                        const spinner = document.createElement('span');
                                        spinner.className = 'spinner';
                                        toast.appendChild(spinner);

                                        // Message
                                        const text = document.createElement('span');
                                        text.textContent = message;
                                        toast.appendChild(text);

                                        document.getElementById('toast-container').appendChild(toast);
                                    }
                                    function removeLoadingToast() {
                                        const toast = document.getElementById('loading-toast');
                                        if (toast) toast.remove();
                                    }

                                    chooseAvatarBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        avatarInput.click();
                                    });

                                    avatarInput.addEventListener('change', async function() {
                                        const file = this.files[0];
                                        if (!file) return;
                                        if (!['image/jpeg', 'image/png'].includes(file.type)) {
                                            showToast('Chỉ chấp nhận ảnh JPEG hoặc PNG!', 'error');
                                            return;
                                        }
                                        if (file.size > 5 * 1024 * 1024) {
                                            showToast('Dung lượng ảnh tối đa 5MB!', 'error');
                                            return;
                                        }
                                        const reader = new FileReader();
                                        reader.onload = function(e) {
                                            avatarPreview.src = e.target.result;
                                            sidebarAvatar.src = e.target.result;
                                        };
                                        reader.readAsDataURL(file);

                                        // Gửi API cập nhật avatar
                                        const userId = localStorage.getItem('userId');
                                        if (!userId) {
                                            showToast('Không tìm thấy userId!', 'error');
                                            return;
                                        }
                                        const formData = new FormData();
                                        formData.append('avatar', file);

                                        showLoadingToast('Đang cập nhật ảnh...');
                                        try {
                                            const res = await fetch(`http://:8080/api/v1/user/avatar/${userId}`, {
                                                method: 'PUT',
                                                body: formData
                                            });
                                            removeLoadingToast();
                                            const json = await res.json();
                                            if (json.statusCode === 200) {
                                                showToast('Cập nhật ảnh thành công!', 'success');
                                                // Nếu backend trả về avatarUrl mới, cập nhật luôn
                                                if (json.data && json.data.avatarUrl) {
                                                    avatarPreview.src = json.data.avatarUrl;
                                                    sidebarAvatar.src = json.data.avatarUrl;
                                                }
                                            } else {
                                                showToast('Cập nhật ảnh thất bại!', 'error');
                                            }
                                        } catch (err) {
                                            removeLoadingToast();
                                            showToast('Có lỗi khi cập nhật ảnh!', 'error');
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer-main></footer-main>

    <!-- Back to top -->
    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>

    <!--===============================================================================================-->
    <script src="./assets/vendor/jquery/jquery-3.2.1.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/animsition/js/animsition.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/bootstrap/js/popper.js"></script>
    <script src="./assets/vendor/bootstrap/js/bootstrap.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/select2/select2.min.js"></script>
    <script>
        $(".js-select2").each(function () {
            $(this).select2({
                minimumResultsForSearch: 20,
                dropdownParent: $(this).next(".dropDownSelect2"),
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script>
        $(".js-pscroll").each(function () {
            $(this).css("position", "relative");
            $(this).css("overflow", "hidden");
            var ps = new PerfectScrollbar(this, {
                wheelSpeed: 1,
                scrollingThreshold: 1000,
                wheelPropagation: false,
            });

            $(window).on("resize", function () {
                ps.update();
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/js/main.js"></script>

</body>

</html>