<!DOCTYPE html>
<html lang="en">

<head>
    <title>Shoping Cart</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="./assets/images/icons/favicon.png" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/bootstrap/css/bootstrap.min.css" />
    <!--===============================================================================================-->
    <!-- <link rel="stylesheet" type="text/css" href="./assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" /> -->
    <link rel="stylesheet" href="./assets/fonts/fontawesome-free-6.1.1-web/css/all.min.css">

    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/iconic/css/material-design-iconic-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/linearicons-v1.0.0/icon-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animate/animate.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/css-hamburgers/hamburgers.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animsition/css/animsition.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/select2/select2.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/perfect-scrollbar/perfect-scrollbar.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/css/util.css" />
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />


    <link rel="stylesheet" href="./assets/css/gridInfo.css">
    <link rel="stylesheet" href="./assets/css/loginInfo.css">
    <link rel="stylesheet" href="./assets/css/header.css">


    <!--===============================================================================================-->

    <!--Header-Template  -->
    <script src="./assets/js/template/header.js"></script>

    <!--Cart-Template  -->
    <script src="./assets/js/template/cart.js"></script>

    <!--Cart-Bread-Template  -->
    <script src="./assets/js/template/cart/bread-crumb.js"></script>

    <!--Cart-Item-Template  -->
    <script src="./assets/js/template/cart/item-cart.js"></script>

    <!--Footer-Template  -->
    <script src="./assets/js/template/footer.js"></script>
</head>

<body class="animsition">
    <!-- Header -->
    <header-main></header-main>


    
    <!-- Search Results Container -->
    <div class="container" style="margin-top: 90px;">
        <div class="row" id="search-results"></div>
    </div>
    <div id="not-found-404" style="display:none;">
        <div class="container-404">
            <div class="">
                <div class="col-md-12">
                    <div class="text-center">
                        <h1 class="error-title-404">404</h1>
                        <p class="error-message-404">Page Not Found</p>
                        <a href="./index.html" class="btn btn-primary">Go to Home</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Favourite logic helpers
        function getFavouriteIds() {
            let favs = [];
            try {
                favs = JSON.parse(localStorage.getItem('favouriteProductIds')) || [];
            } catch (e) {
                favs = [];
            }
            return favs;
        }
        function setFavouriteIds(ids) {
            localStorage.setItem('favouriteProductIds', JSON.stringify(ids));
        }
        function updateFavouriteNotify() {
            const favourites = localStorage.getItem('favouriteProductIds');
            const numberOfFavourites = document.querySelector('.icon-heart-number[data-notify]');
            if (numberOfFavourites) {
                if (favourites) {
                    const favouriteIds = JSON.parse(favourites);
                    numberOfFavourites.setAttribute('data-notify', favouriteIds.length);
                } else {
                    numberOfFavourites.setAttribute('data-notify', '0');
                }
            }
        }
        function formatVND(price) {
            if (isNaN(price)) return '0đ';
            return price.toLocaleString('vi-VN') + 'đ';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            const keyword = params.get('keyword');
            const container = document.getElementById('search-results');
            const notFound = document.getElementById('not-found-404');

            if (keyword) {
                fetch(`http://localhost:8080/api/v1/product/search?keyword=${encodeURIComponent(keyword)}`)
                    .then(res => res.json())
                    .then(response => {
                        // response is { statusCode, message, data: [...] }
                        const products = response.data || [];
                        if (!products || !Array.isArray(products) || products.length === 0) {
                            container.style.display = 'none';
                            notFound.style.display = '';
                            return;
                        }
                        notFound.style.display = 'none';
                        container.style.display = 'flex';
                        renderSearchResults(products);
                    })
                    .catch(err => {
                        container.style.display = 'none';
                        notFound.style.display = '';
                    });
            } else {
                container.style.display = 'none';
                notFound.style.display = '';
            }

            function renderSearchResults(products) {
                container.innerHTML = products.map((product, idx) => {
                    const favIds = getFavouriteIds();
                    const isFav = favIds.includes(product.id);
                    return `
                    <div class="col-sm-6 col-md-4 col-lg-3 p-b-35 isotope-item women">
                        <div class="block2 block2-pic">
                            <div class="block2-pic hov-img0">
                                <img loading="lazy" src="${product.primaryImageURL || product.image}" alt="IMG-PRODUCT" />
                                <a href="productDetail.html?productId=${product.id}"
                                    class="block2-btn flex-c-m stext-103 cl2 size-102 bg0 bor7 hov-btn1 p-lr-15 trans-04 btn-view-detail"
                                    data-product-index="${idx}">
                                    View Detail
                                </a>
                            </div>
                            <div class="block2-txt flex-w flex-t p-t-14">
                                <div class="block2-txt-child1 flex-col-l">
                                    <a href="productDetail.html?productId=${product.id}" class="stext-104 cl4 hov-cl1 trans-04 js-name-detail p-b-6">
                                        ${product.name}
                                    </a>
                                    <div class="price-and-cart">
                                        <span class="stext-106 cl10"> ${formatVND(product.sellingPrice || product.price)}</span>
                                        <span class="original-price">${formatVND(product.originalPrice || '')}</span>
                                    </div>
                                </div>
                                <div class="block2-txt-child2 flex-r p-t-3 heart-and-cart">
                                    <a href="#!" class="btn-addwish-b2 dis-block pos-relative js-addwish-b2 icon-favourite" data-product-index="${idx}">
                                        <img class="icon-heart1 dis-block trans-04" src="./assets/images/icons/icon-heart-01.png"
                                            alt="ICON" style="display:${isFav ? 'none' : 'flex'}" />
                                        <img title="Yêu thích sản phẩm" class="icon-heart2 dis-block trans-04 ab-t-l"
                                            src="./assets/images/icons/icon-heart-02.png" alt="ICON" style="display:${isFav ? '' : 'none'}" />
                                    </a>
                                    <a href="#" class="btn-addcart js-addcart-detail" data-product-index="${idx}">
                                        <i title="Thêm sản phẩm vào giỏ" class="fa-solid fa-cart-shopping"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                // Add event listeners for add-to-cart buttons
                container.querySelectorAll('.btn-addcart').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const idx = this.getAttribute('data-product-index');
                        const product = products[idx];
                        const userId = localStorage.getItem('userId');
                        if (!userId || userId === 'null' || !product || !product.id) {
                            swal("Bạn cần đăng nhập để thêm vào giỏ hàng!", "", "warning");
                            return;
                        }
                        fetch(`http://localhost:8080/api/v1/cart/add?userId=${userId}&productId=${product.id}&quantity=1`, {
                            method: 'POST'
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data && data.statusCode === 201) {
                                    window.dispatchEvent(new Event('cart-updated'));
                                    swal(product.name, "is added to cart !", "success");
                                } else {
                                    swal(product.name, "Có lỗi khi thêm vào giỏ hàng!", "error");
                                }
                            })
                            .catch(() => {
                                swal(product.name, "Có lỗi khi thêm vào giỏ hàng!", "error");
                            });
                    });
                });

                // Add event listeners for add-to-favourite buttons
                container.querySelectorAll('.js-addwish-b2').forEach(btn => {
                    const icon1 = btn.querySelector('.icon-heart1');
                    const icon2 = btn.querySelector('.icon-heart2');
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const idx = this.getAttribute('data-product-index');
                        const product = products[idx];
                        const userId = localStorage.getItem('userId');
                        if (!userId || userId === 'null' || !product || !product.id) {
                            swal("Bạn cần đăng nhập để thêm vào yêu thích!", "", "warning");
                            return;
                        }
                        fetch('http://localhost:8080/api/v1/favourites/toggle', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                userId: Number(userId),
                                productId: product.id
                            })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data && (data.statusCode === 200 || data.statusCode === 201)) {
                                    let favIds = getFavouriteIds();
                                    if (icon1.style.display !== 'none') {
                                        icon1.style.display = 'none';
                                        icon2.style.display = '';
                                        if (!favIds.includes(product.id)) {
                                            favIds.push(product.id);
                                            setFavouriteIds(favIds);
                                        }
                                    } else {
                                        icon1.style.display = '';
                                        icon2.style.display = 'none';
                                        favIds = favIds.filter(id => id !== product.id);
                                        setFavouriteIds(favIds);
                                    }
                                    updateFavouriteNotify();
                                    swal(product.name, "Đã cập nhật danh sách yêu thích!", "success");
                                } else {
                                    swal(product.name, "Có lỗi khi cập nhật yêu thích!", "error");
                                }
                            })
                            .catch(() => {
                                swal(product.name, "Có lỗi khi cập nhậtyêu thích!", "error");
                            });
                    });
                });

                updateFavouriteNotify();
            }
        });
    </script>

    <style>
        .container-404 {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 42vh;
            background-color: #f8f9fa;
        }

        .error-title-404 {
            font-size: 100px;
            color: #dc3545;
        }

        .error-message-404 {
            font-size: 24px;
            color: #6c757d;
        }

        .btn-primary {
            margin-top: 20px;
        }

        .btn {
            background-color: #717fe0;
            margin-right: 22px;
        }

        .btn-primary:hover {
            background-color: #8c98e8;
            color: #fff;
        }
    </style>

    <!-- Footer -->
    <footer-main></footer-main>

    <!-- Back to top -->
    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>

    <!--===============================================================================================-->
    <script src="./assets/vendor/jquery/jquery-3.2.1.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/animsition/js/animsition.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/bootstrap/js/popper.js"></script>
    <script src="./assets/vendor/bootstrap/js/bootstrap.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/select2/select2.min.js"></script>
    <script>
        $(".js-select2").each(function () {
            $(this).select2({
                minimumResultsForSearch: 20,
                dropdownParent: $(this).next(".dropDownSelect2"),
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script>
        $(".js-pscroll").each(function () {
            $(this).css("position", "relative");
            $(this).css("overflow", "hidden");
            var ps = new PerfectScrollbar(this, {
                wheelSpeed: 1,
                scrollingThreshold: 1000,
                wheelPropagation: false,
            });

            $(window).on("resize", function () {
                ps.update();
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/js/main.js"></script>
</body>

</html>