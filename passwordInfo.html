<!DOCTYPE html>
<html lang="en">

<head>
    <title>Shoping Cart</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="./assets/images/icons/favicon.png" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/bootstrap/css/bootstrap.min.css" />
    <!--===============================================================================================-->
    <!-- <link rel="stylesheet" type="text/css" href="./assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css" /> -->
    <link rel="stylesheet" href="./assets/fonts/fontawesome-free-6.1.1-web/css/all.min.css">

    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/iconic/css/material-design-iconic-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/fonts/linearicons-v1.0.0/icon-font.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animate/animate.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/css-hamburgers/hamburgers.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/animsition/css/animsition.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/select2/select2.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/vendor/perfect-scrollbar/perfect-scrollbar.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./assets/css/util.css" />
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css" />


    <link rel="stylesheet" href="./assets/fonts/fontawesome-free-6.1.1-web/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/gridInfo.css">
    <link rel="stylesheet" href="./assets/css/loginInfo.css">
    <link rel="stylesheet" href="./assets/css/header.css">


    <!--===============================================================================================-->
    <!-- Change Sever -->
    <script src="./assets/js/change-sever.js"></script>
    
    <!--Header-Template  -->
    <script src="./assets/js/template/header.js"></script>

    <!--Cart-Template  -->
    <script src="./assets/js/template/cart.js"></script>

    <!--Cart-Bread-Template  -->
    <script src="./assets/js/template/cart/bread-crumb.js"></script>

    <!--Cart-Item-Template  -->
    <script src="./assets/js/template/cart/item-cart.js"></script>

    <!--Footer-Template  -->
    <script src="./assets/js/template/footer.js"></script>
</head>

<body class="animsition">
    <!-- Header -->
    <header-main></header-main>

    <div class="container-info">
        <div class="grid wide">
            <div class="row padding-main">
                <div class="col l-2 ">
                    <div class="category">
                        <div class="category__user">
                            <img src="./assets/images/default-avatar.jpg" alt="" class="category__img" id="sidebarAvatar">
                            <div class="category__information">
                                <span class="category__name"  id="sidebarUserName">User name</span>

                            </div>
                        </div>
                        <div class="myAccount">
                            <div>
                                <a href="loginInfo.html" class="myAccount__link-list">
                                    <i class="myAccount__icon fa-solid fa-user"></i><span>Tài khoản của tôi</span>
                                </a>
                            </div>

                            <div>
                                <a href="#" class="myAccount__link-list active">
                                    <i class="myAccount__icon-ticket fa-solid fa-lock"></i>
                                    <span">Mật khẩu</span>
                                </a>
                            </div>

                            <div>
                                <a href="orderInfo.html" class="myAccount__link-list">
                                    <i class="myAccount__icon-list fa-solid fa-clipboard-list"></i>Đơn mua</span>
                                </a>
                            </div>

                            <!-- <div>
                                <a href="" class="myAccount__link-list">
                                    <i class="myAccount__icon-ticket fa-solid fa-ticket"></i>
                                    <span">Kho Voucher</span>
                                </a>
                            </div> -->

                        </div>
                    </div>
                </div>
                <div class="col l-10 ">
                    <div class="formClient">
                        <div class="formClient__content">
                            <p class="formClient__file-content">Hồ sơ của tôi</p>
                            <p class="formClient__manager-content">Quản lí thông tin hồ sơ để bảo mật tài khoản</p>
                        </div>
                        <div class="row form__infor">
                            <div class="col l-6">
                                <!-- Toast container -->
                                <div id="toast-container"
                                    style="position: fixed; top: 100px; right: 45%; z-index: 9999;"></div>

                                <form action="javascript:void(0);" class="form__user" id="changePasswordForm"
                                    style="padding-right: 15px;">
                                    <div class="login position-relative">
                                        <p class="login__text password-old">Password old</p>
                                        <input type="password" name="oldPassword" id="oldPassword"
                                            class="login__input-text">
                                        <span class="show-btn" onclick="togglePassword('oldPassword', this)"><i
                                                class="fa-solid fa-eye m-l-15" style="cursor: pointer;"></i></span>
                                    </div>
                                    <div class="name mt-12">
                                        <p class="name__text password-new">Password new</p>
                                        <input type="password" name="newPassword" id="newPassword"
                                            class="login__input-text">
                                        <span class="show-btn" onclick="togglePassword('newPassword', this)"><i
                                                class="fa-solid fa-eye m-l-15" style="cursor: pointer;"></i></span>
                                    </div>
                                    <div class="email mt-12">
                                        <p class="email__add confirm-password">Confirm password</p>
                                        <input type="password" name="confirmPassword" id="confirmPassword"
                                            class="login__input-text">
                                        <span class="show-btn" onclick="togglePassword('confirmPassword', this)"><i
                                                class="fa-solid fa-eye m-l-15" style="cursor: pointer;"></i></span>
                                    </div>
                                    <button type="submit" class="link__save ml-15">Lưu</button>
                                    <div id="passwordError" style="color:rgb(242, 26, 26); margin-top:10px;"></div>
                                </form>
                                <script>
                                 
                                    // Load user information into sidebar
                                    document.addEventListener("DOMContentLoaded", function () {
                                        const userId = localStorage.getItem('userId');
                                        if (userId) {
                                            fetch(`http://${changeServer}:8080/api/v1/user/uid/${userId}`)
                                                .then(res => res.json())
                                                .then(json => {
                                                    if (json.statusCode === 200 && json.data) {
                                                        const user = json.data;
                                                        document.getElementById("sidebarUserName").textContent = user.firstName + " " + user.lastName;
                                                        if (user.avatarUrl) {
                                                            document.getElementById("sidebarAvatar").src = user.avatarUrl;
                                                        }
                                                    }
                                                });
                                        }
                                    });

                                    // Toast function
                                    function showToast(message, type = 'info') {
                                        const toast = document.createElement('div');
                                        toast.className = `toast toast-${type}`;
                                        toast.textContent = message;
                                        toast.style.minWidth = '200px';
                                        toast.style.marginBottom = '12px';
                                        toast.style.padding = '12px 24px';
                                        toast.style.borderRadius = '6px';
                                        toast.style.background = type === 'success' ? '#4caf50' : (type === 'error' ? '#f44336' : '#2196f3');
                                        toast.style.color = '#fff';
                                        toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                                        toast.style.fontSize = '16px';
                                        toast.style.opacity = '0.95';
                                        document.getElementById('toast-container').appendChild(toast);
                                        setTimeout(() => {
                                            toast.style.transition = 'opacity 0.5s';
                                            toast.style.opacity = '0';
                                            setTimeout(() => toast.remove(), 500);
                                        }, 2000);
                                    }

                                    // Toggle password visibility
                                    function togglePassword(inputId, btn) {
                                        const input = document.getElementById(inputId);
                                        const icon = btn.querySelector('i');
                                        if (input.type === "password") {
                                            input.type = "text";
                                            icon.classList.remove('fa-eye');
                                            icon.classList.add('fa-eye-slash');
                                        } else {
                                            input.type = "password";
                                            icon.classList.remove('fa-eye-slash');
                                            icon.classList.add('fa-eye');
                                        }
                                    }

                                    // Giả sử userId được lấy từ localStorage/session hoặc server
                                    const userId = localStorage.getItem('userId') || '1';

                                    function validateNewPassword(password) {
                                        // At least 6 chars, at least 1 uppercase, at least 1 number
                                        const lengthValid = password.length >= 6;
                                        const hasUpper = /[A-Z]/.test(password);
                                        const hasNumber = /\d/.test(password);
                                        return lengthValid && hasUpper && hasNumber;
                                    }

                                    document.getElementById('changePasswordForm').addEventListener('submit', async function (e) {
                                        e.preventDefault();
                                        const oldPassword = document.getElementById('oldPassword').value;
                                        const newPassword = document.getElementById('newPassword').value;
                                        const confirmPassword = document.getElementById('confirmPassword').value;
                                        const errorDiv = document.getElementById('passwordError');
                                        errorDiv.textContent = '';

                                        if (!validateNewPassword(newPassword)) {
                                            errorDiv.textContent = 'Mật khẩu mới phải có ít nhất 6 ký tự, 1 chữ hoa và 1 số!';
                                            return;
                                        }

                                        if (newPassword !== confirmPassword) {
                                            errorDiv.textContent = 'Mật khẩu mới và xác nhận mật khẩu không khớp !';
                                            return;
                                        }

                                        try {
                                            const res = await fetch(`http://${changeServer}:8080/api/v1/auth/change-password/${userId}`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    oldPassword,
                                                    newPassword,
                                                    confirmPassword
                                                })
                                            });
                                            if (res.ok) {
                                                showToast('Đổi mật khẩu thành công!', 'success');
                                                document.getElementById('changePasswordForm').reset();
                                            } else {
                                                const data = await res.json();
                                                errorDiv.textContent = "Mật khẩu cũ không khớp" || 'Đổi mật khẩu thất bại!';
                                                showToast('Đổi mật khẩu thất bại!', 'error');
                                            }
                                        } catch (err) {
                                            errorDiv.textContent = 'Có lỗi xảy ra. Vui lòng thử lại!';
                                            showToast('Có lỗi xảy ra. Vui lòng thử lại!', 'error');
                                        }
                                    });
                                </script>
                            </div>
                            <div class="col l-6">
                                <div class="info-password">
                                    <p class="myImg__contetn"><i class="myImg__lock fa-solid fa-lock"></i>Mật khẩu trong
                                        khoảng 8-50 ký tự</p>
                                    <p class="myImg__contetn"><i class="myImg__lock fa-solid fa-lock"></i>Mật khẩu không
                                        được trùng số điện thoại/ username</p>
                                    <p class="myImg__contetn"><i class="myImg__lock fa-solid fa-lock"></i>Mật khẩu bắt
                                        buộc phải bao gồm ít nhất 01 chữ viết thường, 01 số và 01 chữ viết hoa</p>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer-main></footer-main>


    <!-- Back to top -->
    <div class="btn-back-to-top" id="myBtn">
        <span class="symbol-btn-back-to-top">
            <i class="zmdi zmdi-chevron-up"></i>
        </span>
    </div>

    <!--===============================================================================================-->
    <script src="./assets/vendor/jquery/jquery-3.2.1.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/animsition/js/animsition.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/bootstrap/js/popper.js"></script>
    <script src="./assets/vendor/bootstrap/js/bootstrap.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/select2/select2.min.js"></script>
    <script>
        $(".js-select2").each(function () {
            $(this).select2({
                minimumResultsForSearch: 20,
                dropdownParent: $(this).next(".dropDownSelect2"),
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
    <!--===============================================================================================-->
    <script src="./assets/vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script>
        $(".js-pscroll").each(function () {
            $(this).css("position", "relative");
            $(this).css("overflow", "hidden");
            var ps = new PerfectScrollbar(this, {
                wheelSpeed: 1,
                scrollingThreshold: 1000,
                wheelPropagation: false,
            });

            $(window).on("resize", function () {
                ps.update();
            });
        });
    </script>
    <!--===============================================================================================-->
    <script src="./assets/js/main.js"></script>
</body>

</html>